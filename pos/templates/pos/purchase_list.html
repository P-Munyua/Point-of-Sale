{% extends 'pos/base.html' %}

{% block content %}
<div class="bg-white rounded-lg shadow p-6">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold">Purchases & Returns</h2>
        <div class="space-x-2">
            <a href="{% url 'add_purchase' %}" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md">
                <i class="fas fa-plus mr-1"></i> New Purchase
            </a>
            <a href="{% url 'create_purchase_return' %}" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-md">
                <i class="fas fa-undo mr-1"></i> New Return
            </a>
            <a href="{% url 'pending_purchases' %}" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-md">
                <i class="fas fa-clock mr-1"></i> Pending Purchases
            </a>
        </div>
    </div>

    <!-- Filters -->
    <div class="bg-gray-50 p-4 rounded-lg mb-6">
        <form method="get" class="grid grid-cols-1 md:grid-cols-5 gap-4">
            <!-- Date Range -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                <input type="date" name="start_date" value="{{ request.GET.start_date }}" class="w-full p-2 border rounded-md">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                <input type="date" name="end_date" value="{{ request.GET.end_date }}" class="w-full p-2 border rounded-md">
            </div>

            <!-- Supplier Filter -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Supplier</label>
                <select name="supplier" class="w-full p-2 border rounded-md">
                    <option value="">All Suppliers</option>
                    {% for supplier in suppliers %}
                        <option value="{{ supplier.id }}" {% if request.GET.supplier == supplier.id|stringformat:"s" %}selected{% endif %}>
                            {{ supplier.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <!-- Transaction Type Filter -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Transaction Type</label>
                <select name="is_return" class="w-full p-2 border rounded-md">
                    <option value="">All Transactions</option>
                    <option value="false" {% if request.GET.is_return == 'false' %}selected{% endif %}>Purchases Only</option>
                    <option value="true" {% if request.GET.is_return == 'true' %}selected{% endif %}>Returns Only</option>
                </select>
            </div>

            <!-- Return Status Filter (shown only when viewing returns) -->
            {% if request.GET.is_return == 'true' %}
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Return Status</label>
                <select name="return_status" class="w-full p-2 border rounded-md">
                    <option value="">All Statuses</option>
                    <option value="pending" {% if request.GET.return_status == 'pending' %}selected{% endif %}>Pending</option>
                    <option value="approved" {% if request.GET.return_status == 'approved' %}selected{% endif %}>Approved</option>
                    <option value="rejected" {% if request.GET.return_status == 'rejected' %}selected{% endif %}>Rejected</option>
                </select>
            </div>
            {% endif %}

            <div class="md:col-span-5 flex justify-end space-x-2">
                <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md">
                    <i class="fas fa-filter mr-1"></i> Filter
                </button>
                <a href="{% url 'purchase_list' %}" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-md">
                    <i class="fas fa-sync-alt mr-1"></i> Reset
                </a>
            </div>
        </form>
    </div>

    <!-- Summary Stats -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-blue-50 p-4 rounded-lg">
            <h3 class="text-sm font-medium text-blue-800">Total Purchases</h3>
            <p class="text-2xl font-bold text-blue-600">KSh {{ total_purchases|floatformat:2 }}</p>
        </div>
        <div class="bg-red-50 p-4 rounded-lg">
            <h3 class="text-sm font-medium text-red-800">Total Returns</h3>
            <p class="text-2xl font-bold text-red-600">KSh {{ total_returns|floatformat:2 }}</p>
        </div>
        <div class="bg-green-50 p-4 rounded-lg">
            <h3 class="text-sm font-medium text-green-800">Total Items</h3>
            <p class="text-2xl font-bold text-green-600">{{ total_items }}</p>
        </div>
        <div class="bg-purple-50 p-4 rounded-lg">
            <h3 class="text-sm font-medium text-purple-800">Total Transactions</h3>
            <p class="text-2xl font-bold text-purple-600">{{ purchases.paginator.count }}</p>
        </div>
    </div>

    <!-- Purchases Table -->
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Invoice #
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Date
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Supplier
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Items
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Total
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Status
                    </th>
                    <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Actions
                    </th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for purchase in purchases %}
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        {% if purchase.is_return %}
                        <span class="text-red-500">RET-{{ purchase.invoice_number }}</span>
                        {% else %}
                        {{ purchase.invoice_number }}
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ purchase.date|date:"d/m/Y H:i" }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ purchase.supplier.name }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ purchase.item_count }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium {% if purchase.is_return %}text-red-600{% else %}text-gray-900{% endif %}">
                        {% if purchase.is_return %}-{% endif %}KSh {{ purchase.total|floatformat:2 }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        {% if purchase.is_return %}
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                            {% if purchase.return_status == 'approved' %}bg-green-100 text-green-800
                            {% elif purchase.return_status == 'rejected' %}bg-red-100 text-red-800
                            {% else %}bg-yellow-100 text-yellow-800{% endif %}">
                            {{ purchase.get_return_status_display }}
                        </span>
                        {% else %}
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                            {% if purchase.is_paid %}bg-green-100 text-green-800{% else %}bg-yellow-100 text-yellow-800{% endif %}">
                            {% if purchase.is_paid %}Paid{% else %}Unpaid{% endif %}
                        </span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                        <a href="{% url 'view_purchase' purchase.id %}" class="text-blue-600 hover:text-blue-900" title="View">
                            <i class="fas fa-eye"></i>
                        </a>
                        {% if not purchase.is_return %}
                        <a href="{% url 'edit_purchase' purchase.id %}" class="text-yellow-600 hover:text-yellow-900" title="Edit">
                            <i class="fas fa-edit"></i>
                        </a>
                        {% endif %}
                        {% if not purchase.is_return and not purchase.is_paid %}
                        <a href="{% url 'record_payment' purchase.id %}" class="text-green-600 hover:text-green-900" title="Record Payment">
                            <i class="fas fa-money-bill-wave"></i>
                        </a>
                       
                        {% endif %}
                        {% if purchase.is_return and purchase.return_status == 'pending' %}
                        <a href="{% url 'process_return' purchase.id %}" class="text-purple-600 hover:text-purple-900" title="Process Return">
                            <i class="fas fa-cog"></i>
                        </a>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" class="px-6 py-4 text-center text-sm text-gray-500">
                        No transactions found matching your filters.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {% if purchases.has_other_pages %}
    <div class="mt-6 flex items-center justify-between">
        <div class="text-sm text-gray-700">
            Showing {{ purchases.start_index }} to {{ purchases.end_index }} of {{ purchases.paginator.count }} entries
        </div>
        <div class="flex space-x-2">
            {% if purchases.has_previous %}
                <a href="?{% if request.GET.start_date %}start_date={{ request.GET.start_date }}&{% endif %}{% if request.GET.end_date %}end_date={{ request.GET.end_date }}&{% endif %}{% if request.GET.supplier %}supplier={{ request.GET.supplier }}&{% endif %}{% if request.GET.is_return %}is_return={{ request.GET.is_return }}&{% endif %}{% if request.GET.return_status %}return_status={{ request.GET.return_status }}&{% endif %}page=1" 
                   class="px-3 py-1 border rounded-md hover:bg-gray-100">
                    &laquo; First
                </a>
                <a href="?{% if request.GET.start_date %}start_date={{ request.GET.start_date }}&{% endif %}{% if request.GET.end_date %}end_date={{ request.GET.end_date }}&{% endif %}{% if request.GET.supplier %}supplier={{ request.GET.supplier }}&{% endif %}{% if request.GET.is_return %}is_return={{ request.GET.is_return }}&{% endif %}{% if request.GET.return_status %}return_status={{ request.GET.return_status }}&{% endif %}page={{ purchases.previous_page_number }}" 
                   class="px-3 py-1 border rounded-md hover:bg-gray-100">
                    Previous
                </a>
            {% endif %}

            {% for num in purchases.paginator.page_range %}
                {% if purchases.number == num %}
                    <span class="px-3 py-1 border rounded-md bg-blue-500 text-white">{{ num }}</span>
                {% elif num > purchases.number|add:'-3' and num < purchases.number|add:'3' %}
                    <a href="?{% if request.GET.start_date %}start_date={{ request.GET.start_date }}&{% endif %}{% if request.GET.end_date %}end_date={{ request.GET.end_date }}&{% endif %}{% if request.GET.supplier %}supplier={{ request.GET.supplier }}&{% endif %}{% if request.GET.is_return %}is_return={{ request.GET.is_return }}&{% endif %}{% if request.GET.return_status %}return_status={{ request.GET.return_status }}&{% endif %}page={{ num }}" 
                       class="px-3 py-1 border rounded-md hover:bg-gray-100">
                        {{ num }}
                    </a>
                {% endif %}
            {% endfor %}

            {% if purchases.has_next %}
                <a href="?{% if request.GET.start_date %}start_date={{ request.GET.start_date }}&{% endif %}{% if request.GET.end_date %}end_date={{ request.GET.end_date }}&{% endif %}{% if request.GET.supplier %}supplier={{ request.GET.supplier }}&{% endif %}{% if request.GET.is_return %}is_return={{ request.GET.is_return }}&{% endif %}{% if request.GET.return_status %}return_status={{ request.GET.return_status }}&{% endif %}page={{ purchases.next_page_number }}" 
                   class="px-3 py-1 border rounded-md hover:bg-gray-100">
                    Next
                </a>
                <a href="?{% if request.GET.start_date %}start_date={{ request.GET.start_date }}&{% endif %}{% if request.GET.end_date %}end_date={{ request.GET.end_date }}&{% endif %}{% if request.GET.supplier %}supplier={{ request.GET.supplier }}&{% endif %}{% if request.GET.is_return %}is_return={{ request.GET.is_return }}&{% endif %}{% if request.GET.return_status %}return_status={{ request.GET.return_status }}&{% endif %}page={{ purchases.paginator.num_pages }}" 
                   class="px-3 py-1 border rounded-md hover:bg-gray-100">
                    Last &raquo;
                </a>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Export Button -->
    <div class="mt-4">
        <a href="?export=csv{% if request.GET.start_date %}&start_date={{ request.GET.start_date }}{% endif %}{% if request.GET.end_date %}&end_date={{ request.GET.end_date }}{% endif %}{% if request.GET.supplier %}&supplier={{ request.GET.supplier }}{% endif %}{% if request.GET.is_return %}&is_return={{ request.GET.is_return }}{% endif %}{% if request.GET.return_status %}&return_status={{ request.GET.return_status }}{% endif %}" 
           class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
            <i class="fas fa-file-export mr-2"></i> Export to CSV
        </a>
    </div>
</div>
{% endblock %}