{% extends 'pos/base.html' %}
{% load static %}

{% block content %}
{% if not purchase %}
<div class="max-w-4xl mx-auto bg-white rounded-lg shadow-md overflow-hidden mt-10">
    <div class="bg-red-50 px-6 py-8 border-b border-red-200">
        <div class="flex items-center">
            <div class="bg-red-100 p-3 rounded-full mr-4">
                <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
            </div>
            <div>
                <h2 class="text-xl font-semibold text-red-800">Purchase Not Found</h2>
                <p class="text-red-600 mt-1">The purchase you're trying to edit does not exist or has been deleted.</p>
            </div>
        </div>
    </div>
    
    <div class="px-6 py-6">
        <p class="text-gray-700 mb-4">Possible reasons for this error:</p>
        <ul class="list-disc pl-5 text-gray-600 mb-6">
            <li>The purchase ID in the URL is incorrect</li>
            <li>The purchase has been deleted from the system</li>
            <li>You don't have permission to access this purchase</li>
        </ul>
        
        <div class="flex space-x-3">
            <a href="{% url 'purchase_list' %}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                <i class="fas fa-list mr-2"></i> View All Purchases
            </a>
            <a href="{% url 'add_purchase' %}" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md shadow-sm text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                <i class="fas fa-plus mr-2"></i> Create New Purchase
            </a>
        </div>
    </div>
</div>
{% else %}
<div class="max-w-6xl mx-auto bg-white rounded-lg shadow overflow-hidden">
    <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
        <h2 class="text-xl font-semibold text-gray-800">Edit Purchase - {{ purchase.invoice_number }}</h2>
        <a href="{% url 'purchase_list' %}" class="text-blue-600 hover:text-blue-800 text-sm">
            <i class="fas fa-arrow-left mr-1"></i> Back to Purchases
        </a>
    </div>

    <form method="post" id="purchase-form" class="px-6 py-4">
        {% csrf_token %}
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Supplier *</label>
                <select name="supplier" id="supplier-select" class="w-full p-2 border rounded-md" required>
                    <option value="">Select Supplier</option>
                    {% for supplier in suppliers %}
                    <option value="{{ supplier.id }}" {% if purchase.supplier.id == supplier.id %}selected{% endif %}>{{ supplier.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Invoice Number</label>
                <input type="text" name="invoice_number" id="invoice-number" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" 
                       value="{{ purchase.invoice_number }}" readonly>
            </div>
        </div>

        <div class="mb-6">
            <h3 class="text-lg font-medium text-gray-700 mb-3">Purchase Items</h3>
            <div class="mb-3">
                <div class="relative">
                    <input type="text" id="product-search" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" 
                           placeholder="Search products by name or barcode..." autocomplete="off"
                           data-search-url="{% url 'search_products' %}">
                    <div id="product-results" class="absolute z-10 mt-1 w-full bg-white shadow-lg rounded-md border border-gray-300 hidden max-h-60 overflow-auto"></div>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unit Price</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Batch</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                        </tr>
                    </thead>
                    <tbody id="items-container" class="bg-white divide-y divide-gray-200">
                        {% for item in purchase.items.all %}
                        <tr class="item-row" data-index="{{ forloop.counter0 }}" data-product-id="{{ item.product.id }}">
                            <td class="px-4 py-3 whitespace-nowrap">
                                <input type="hidden" name="items[{{ forloop.counter0 }}][product_id]" value="{{ item.product.id }}">
                                <div class="font-medium">{{ item.product.name }}</div>
                                <div class="text-xs text-gray-500">SKU: {{ item.product.sku }}</div>
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap">
                                <input type="number" class="item-quantity w-full px-2 py-1 border rounded" 
                                       name="items[{{ forloop.counter0 }}][quantity]" value="{{ item.quantity }}" min="1" data-index="{{ forloop.counter0 }}">
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap">
                                <input type="number" class="item-price w-full px-2 py-1 border rounded" 
                                       name="items[{{ forloop.counter0 }}][price]" value="{{ item.price|floatformat:2 }}" min="0.01" step="0.01" data-index="{{ forloop.counter0 }}">
                                <div class="text-xs text-gray-500 mt-1">Cost: KSh {{ item.price|floatformat:2 }}</div>
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap">
                                <span class="item-total">KSh {{ item.total|floatformat:2 }}</span>
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap">
                                <div class="grid grid-cols-2 gap-2">
                                    <input type="text" class="item-batch w-full px-2 py-1 border rounded" 
                                           name="items[{{ forloop.counter0 }}][batch_number]" placeholder="Batch #" value="{% if item.batch %}{{ item.batch.batch_number }}{% endif %}" data-index="{{ forloop.counter0 }}">
                                    <input type="date" class="item-expiry w-full px-2 py-1 border rounded" 
                                           name="items[{{ forloop.counter0 }}][expiry_date]" value="{% if item.batch and item.batch.expiry_date %}{{ item.batch.expiry_date|date:'Y-m-d' }}{% endif %}" data-index="{{ forloop.counter0 }}">
                                </div>
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap">
                                <button type="button" class="remove-item text-red-600 hover:text-red-800" data-index="{{ forloop.counter0 }}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <div class="mt-3 flex justify-between items-center">
                <button type="button" id="add-item" class="inline-flex items-center px-3 py-1 border border-transparent text-sm leading-4 font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    <i class="fas fa-plus mr-1"></i> Add Item
                </button>
                <span id="item-count" class="text-sm text-gray-500">{{ purchase.items.count }} items</span>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div class="bg-gray-50 p-4 rounded-lg">
                <h4 class="text-sm font-medium text-gray-700 mb-2">Subtotal</h4>
                <p class="text-xl font-semibold" id="subtotal-display">KSh {{ purchase.subtotal|floatformat:2 }}</p>
            </div>
            <div class="bg-blue-50 p-4 rounded-lg">
                <h4 class="text-sm font-medium text-blue-700 mb-2">Total Amount</h4>
                <p class="text-2xl font-bold text-blue-600" id="total-display">KSh {{ purchase.total|floatformat:2 }}</p>
            </div>
        </div>

        <div class="flex justify-end space-x-2">
            <button type="button" id="save-as-pending" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-yellow-600 hover:bg-yellow-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500">
                <i class="fas fa-save mr-1"></i> Save as Pending
            </button>
            <button type="submit" id="save-purchase" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                <i class="fas fa-save mr-1"></i> Save Purchase
            </button>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // JavaScript for handling dynamic item management
    let itemCount = {{ purchase.items.count }};
    const itemsContainer = document.getElementById('items-container');
    const itemCountDisplay = document.getElementById('item-count');
    const subtotalDisplay = document.getElementById('subtotal-display');
    const totalDisplay = document.getElementById('total-display');
    const searchInput = document.getElementById('product-search');
    const resultsContainer = document.getElementById('product-results');
    const searchUrl = searchInput.getAttribute('data-search-url');

    // Calculate totals
    function calculateTotals() {
        let subtotal = 0;
        document.querySelectorAll('.item-row').forEach(row => {
            const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
            const price = parseFloat(row.querySelector('.item-price').value) || 0;
            const total = quantity * price;
            row.querySelector('.item-total').textContent = `KSh ${total.toFixed(2)}`;
            subtotal += total;
        });
        
        subtotalDisplay.textContent = `KSh ${subtotal.toFixed(2)}`;
        totalDisplay.textContent = `KSh ${subtotal.toFixed(2)}`;
        itemCountDisplay.textContent = `${document.querySelectorAll('.item-row').length} items`;
    }
    
    // Add event listeners for quantity and price changes
    function attachInputListeners() {
        document.querySelectorAll('.item-quantity, .item-price').forEach(input => {
            // Remove any existing listeners to avoid duplicates
            input.replaceWith(input.cloneNode(true));
        });
        
        // Reattach listeners
        document.querySelectorAll('.item-quantity, .item-price').forEach(input => {
            input.addEventListener('input', calculateTotals);
        });
    }
    
    // Remove item functionality
    function attachRemoveListeners() {
        document.querySelectorAll('.remove-item').forEach(button => {
            // Remove any existing listeners to avoid duplicates
            button.replaceWith(button.cloneNode(true));
        });
        
        // Reattach listeners
        document.querySelectorAll('.remove-item').forEach(button => {
            button.addEventListener('click', function() {
                const index = this.getAttribute('data-index');
                document.querySelector(`.item-row[data-index="${index}"]`).remove();
                calculateTotals();
            });
        });
    }
    
    // Initialize listeners
    attachInputListeners();
    attachRemoveListeners();
    
    // Product search functionality
    let searchTimeout = null;
    
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const query = this.value.trim();

        if (query.length < 2) {
            resultsContainer.innerHTML = '';
            resultsContainer.classList.add('hidden');
            return;
        }

        searchTimeout = setTimeout(() => {
            fetch(`${searchUrl}?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        resultsContainer.innerHTML = data.map(p => `
                            <div class="p-2 hover:bg-gray-100 cursor-pointer product-result"
                                 data-id="${p.id}" data-name="${p.name}" 
                                 data-price="${p.price}" data-sku="${p.sku}">
                                <div class="font-medium">${p.name}</div>
                                <div class="text-xs text-gray-500">SKU: ${p.sku} | Price: KSh ${p.price}</div>
                            </div>
                        `).join('');
                        resultsContainer.classList.remove('hidden');
                    } else {
                        resultsContainer.innerHTML = '<div class="p-2 text-gray-500">No products found</div>';
                        resultsContainer.classList.remove('hidden');
                    }
                })
                .catch(error => {
                    console.error('Error searching products:', error);
                    resultsContainer.innerHTML = '<div class="p-2 text-red-500">Error searching products</div>';
                    resultsContainer.classList.remove('hidden');
                });
        }, 300); // debounce 300ms
    });

    // Handle product selection from search results
    resultsContainer.addEventListener('click', function(e) {
        const item = e.target.closest('.product-result');
        if (item) {
            const productId = item.dataset.id;
            const productName = item.dataset.name;
            const price = parseFloat(item.dataset.price).toFixed(2);
            const sku = item.dataset.sku;

            // Check if product already exists in the list
            const existingRow = document.querySelector(`.item-row[data-product-id="${productId}"]`);
            if (existingRow) {
                // Increase quantity if product already exists
                const quantityInput = existingRow.querySelector('.item-quantity');
                quantityInput.value = parseInt(quantityInput.value) + 1;
                calculateTotals();
                
                // Reset search
                resultsContainer.innerHTML = '';
                resultsContainer.classList.add('hidden');
                searchInput.value = '';
                return;
            }

            // Add new row to table
            const newIndex = document.querySelectorAll('.item-row').length;
            const rowHtml = `
                <tr class="item-row" data-index="${newIndex}" data-product-id="${productId}">
                    <td class="px-4 py-3 whitespace-nowrap">
                        <input type="hidden" name="items[${newIndex}][product_id]" value="${productId}">
                        <div class="font-medium">${productName}</div>
                        <div class="text-xs text-gray-500">SKU: ${sku}</div>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <input type="number" class="item-quantity w-full px-2 py-1 border rounded" 
                               name="items[${newIndex}][quantity]" value="1" min="1" data-index="${newIndex}">
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <input type="number" class="item-price w-full px-2 py-1 border rounded" 
                               name="items[${newIndex}][price]" value="${price}" min="0.01" step="0.01" data-index="${newIndex}">
                        <div class="text-xs text-gray-500 mt-1">Cost: KSh ${price}</div>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <span class="item-total">KSh ${price}</span>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <div class="grid grid-cols-2 gap-2">
                            <input type="text" class="item-batch w-full px-2 py-1 border rounded" 
                                   name="items[${newIndex}][batch_number]" placeholder="Batch #" data-index="${newIndex}">
                            <input type="date" class="item-expiry w-full px-2 py-1 border rounded" 
                                   name="items[${newIndex}][expiry_date]" data-index="${newIndex}">
                        </div>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <button type="button" class="remove-item text-red-600 hover:text-red-800" data-index="${newIndex}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;

            itemsContainer.insertAdjacentHTML('beforeend', rowHtml);

            // Reattach listeners for all inputs
            attachInputListeners();
            attachRemoveListeners();

            // Update totals
            calculateTotals();

            // Reset search box
            resultsContainer.innerHTML = '';
            resultsContainer.classList.add('hidden');
            searchInput.value = '';
        }
    });

    // Hide search results when clicking outside
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !resultsContainer.contains(e.target)) {
            resultsContainer.classList.add('hidden');
        }
    });

    // Manual add item button
    document.getElementById('add-item').addEventListener('click', function() {
        // Create an empty row for manual entry
        const newIndex = document.querySelectorAll('.item-row').length;
        const newRow = document.createElement('tr');
        newRow.className = 'item-row';
        newRow.dataset.index = newIndex;
        
        newRow.innerHTML = `
            <td class="px-4 py-3 whitespace-nowrap">
                <input type="hidden" name="items[${newIndex}][product_id]" value="">
                <div class="font-medium">Manual Entry</div>
                <div class="text-xs text-gray-500">SKU: N/A</div>
            </td>
            <td class="px-4 py-3 whitespace-nowrap">
                <input type="number" class="item-quantity w-full px-2 py-1 border rounded" 
                       name="items[${newIndex}][quantity]" value="1" min="1" data-index="${newIndex}">
            </td>
            <td class="px-4 py-3 whitespace-nowrap">
                <input type="number" class="item-price w-full px-2 py-1 border rounded" 
                       name="items[${newIndex}][price]" value="0.00" min="0.01" step="0.01" data-index="${newIndex}">
                <div class="text-xs text-gray-500 mt-1">Cost: KSh 0.00</div>
            </td>
            <td class="px-4 py-3 whitespace-nowrap">
                <span class="item-total">KSh 0.00</span>
            </td>
            <td class="px-4 py-3 whitespace-nowrap">
                <div class="grid grid-cols-2 gap-2">
                    <input type="text" class="item-batch w-full px-2 py-1 border rounded" 
                           name="items[${newIndex}][batch_number]" placeholder="Batch #" data-index="${newIndex}">
                    <input type="date" class="item-expiry w-full px-2 py-1 border rounded" 
                           name="items[${newIndex}][expiry_date]" data-index="${newIndex}">
                </div>
            </td>
            <td class="px-4 py-3 whitespace-nowrap">
                <button type="button" class="remove-item text-red-600 hover:text-red-800" data-index="${newIndex}">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        
        itemsContainer.appendChild(newRow);
        
        // Reattach listeners for all inputs
        attachInputListeners();
        attachRemoveListeners();
        
        calculateTotals();
    });
    
    // Save as pending button functionality
    document.getElementById('save-as-pending').addEventListener('click', function() {
        const form = document.getElementById('purchase-form');
        // You might want to add a hidden field to indicate pending status
        const statusField = document.createElement('input');
        statusField.type = 'hidden';
        statusField.name = 'status';
        statusField.value = 'pending';
        form.appendChild(statusField);
        
        form.submit();
    });
    
    // Initialize totals
    calculateTotals();
});
</script>
{% endif %}
{% endblock %}